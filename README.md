# Webãƒ–ãƒ©ã‚¦ã‚¶ã§å­¦ã¶SQLå…¥é–€ã‚¢ãƒ—ãƒª

Streamlitã¨DuckDBã‚’ä½¿ã£ãŸã€åˆå­¦è€…å‘ã‘ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªSQLå­¦ç¿’ã‚¢ãƒ—ãƒªã§ã™ã€‚

## ç‰¹å¾´

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼: SQLã®å®Ÿè¡Œçµæžœã‚’å³åº§ã«ç¢ºèª
- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªSQLã‚¨ãƒ‡ã‚£ã‚¿: ã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ã™ãã«è©¦ã›ã‚‹
- è±Šå¯Œãªã‚µãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒª: ã‚ˆãä½¿ã†SQLæ–‡ã®ä¾‹ã‚’ç”¨æ„
- åˆå­¦è€…ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼: ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ä»˜ã
- ãƒãƒ¼ã‚¿ãƒ–ãƒ«: ãƒ­ãƒ¼ã‚«ãƒ«ã€EC2ã€ã‚³ãƒ³ãƒ†ãƒŠã©ã“ã§ã‚‚å‹•ä½œ

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
cd sql_workbook

# ä»®æƒ³ç’°å¢ƒã®ä½œæˆï¼ˆæŽ¨å¥¨ï¼‰
python -m venv .venv
source .venv/bin/activate

# ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ã‚¢ãƒ—ãƒªã®èµ·å‹•
streamlit run app.py
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8501` ã‚’é–‹ãã¨ã‚¢ãƒ—ãƒªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### Dockerç’°å¢ƒ

```bash
# Dockerfileã‚’ä½œæˆã—ã¦å®Ÿè¡Œ
docker build -t sql-learning-app .
docker run -p 8501:8501 sql-learning-app
```

### EC2/ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒ

```bash
# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
nohup streamlit run app.py --server.port 8501 --server.address 0.0.0.0 &
```

## ä½¿ã„æ–¹

1. ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç¢ºèª: å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ç·´ç¿’å•é¡Œã‚’è¦‹ã‚‹: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒðŸ“ ç·´ç¿’å•é¡Œã€ãƒªãƒ³ã‚¯ã‹ã‚‰å•é¡Œé›†ã«ã‚¢ã‚¯ã‚»ã‚¹
3. SQLã‚’æ›¸ã: å·¦ã‚«ãƒ©ãƒ ã®ã‚¨ãƒ‡ã‚£ã‚¿ã«SQLã‚¯ã‚¨ãƒªã‚’å…¥åŠ›
4. å®Ÿè¡Œ: ã€Œâ–¶ï¸ å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. çµæžœã‚’ç¢ºèª: å³ã‚«ãƒ©ãƒ ã«çµæžœãŒè¡¨ç¤ºã•ã‚Œã¾ã™

### ç·´ç¿’å•é¡Œã«ã¤ã„ã¦

`EXERCISES.md` ã«ç·´ç¿’å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

#### æ¨™æº–SQLã¨å®Ÿç”¨æ€§ã®ãƒãƒ©ãƒ³ã‚¹

ã“ã®ã‚¢ãƒ—ãƒªã¯æ¨™æº–SQLï¼ˆISO/IEC 9075ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã¾ã™ãŒã€å®Ÿå‹™ã§ã®ä½¿ã„ã‚„ã™ã•ã‚‚è€ƒæ…®ã—ã¦ã„ã¾ã™ã€‚

çµæžœä»¶æ•°ã®åˆ¶é™ã«ã¤ã„ã¦:
- æ¨™æº–SQL: `FETCH FIRST n ROWS ONLY` ï¼ˆSQL:2008ï¼‰
- å®Ÿå‹™ã§ã®æ…£ä¾‹: `LIMIT n` ï¼ˆPostgreSQLã€MySQLã€BigQueryã€Athenaã€Snowflakeã€DuckDBãªã©ï¼‰

å•é¡Œ1ã§ `FETCH FIRST` ã‚’ç´¹ä»‹ã—ãŸä¸Šã§ã€ä»¥é™ã®å•é¡Œã§ã¯å®Ÿå‹™ã§ä¸€èˆ¬çš„ãª `LIMIT` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ä¸»è¦ãªã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã§æ¨™æº–çš„ãªæ›¸ãæ–¹ã§ã™ã€‚

ä½¿ç”¨ã—ã¦ã„ã‚‹æ¨™æº–SQLæ©Ÿèƒ½:
- `EXTRACT()` - æ—¥ä»˜ã‹ã‚‰å¹´æœˆæ—¥ãƒ»æ›œæ—¥ã‚’æŠ½å‡ºï¼ˆSQL:1992ï¼‰
- `SUBSTRING()` - æ–‡å­—åˆ—ã®éƒ¨åˆ†å–å¾—ï¼ˆSQL:1992ï¼‰
- `||` - æ–‡å­—åˆ—çµåˆæ¼”ç®—å­ï¼ˆSQL:1992ï¼‰
- Windowé–¢æ•° - RANK, ROW_NUMBER, LAG, LEAD ãªã©ï¼ˆSQL:2003ï¼‰
- CTEï¼ˆWITHå¥ï¼‰- è¤‡é›‘ãªã‚¯ã‚¨ãƒªã®æ§‹é€ åŒ–ï¼ˆSQL:1999ï¼‰
- CASEå¼ã€JOINã€GROUP BY ãªã©åŸºæœ¬æ©Ÿèƒ½ï¼ˆSQL:1992ï¼‰

å„å•é¡Œã«ã¯ï¼š
- å•é¡Œæ–‡
- ãƒ’ãƒ³ãƒˆ
- å›žç­”ä¾‹
- è§£èª¬

ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚åˆå¿ƒè€…ã¯å†™çµŒã§æ›¸ã„ã¦ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå†™ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æ‰‹ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚ä¸­ç´šè€…ä»¥ä¸Šã¯ã¾ãšè‡ªåˆ†ã§è€ƒãˆã¦ã‹ã‚‰å›žç­”ã‚’è¦‹ã‚‹ãªã©ãƒ¬ãƒ™ãƒ«åˆ¥ã§æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

ã‚¢ãƒ—ãƒªã«ã¯å°å£²æ¥­ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼š

### `sales` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå£²ä¸Šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- sale_id: å£²ä¸ŠID
- sale_date: è²©å£²æ—¥
- customer_id: é¡§å®¢ID
- product_id: å•†å“ID
- store_id: åº—èˆ—ID
- quantity: æ•°é‡
- unit_price: å˜ä¾¡
- discount_rate: å‰²å¼•çŽ‡

### `products` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå•†å“ãƒžã‚¹ã‚¿ï¼‰
- product_id: å•†å“ID
- product_name: å•†å“å
- category: ã‚«ãƒ†ã‚´ãƒªï¼ˆå®¶é›»ã€å®¶å…·ï¼‰
- subcategory: ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª
- standard_price: æ¨™æº–ä¾¡æ ¼

### `customers` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé¡§å®¢ãƒžã‚¹ã‚¿ï¼‰
- customer_id: é¡§å®¢ID
- customer_name: é¡§å®¢å
- customer_segment: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆVIPã€Regularã€Newï¼‰
- registration_date: ç™»éŒ²æ—¥
- prefecture: éƒ½é“åºœçœŒ
- age_group: å¹´é½¢å±¤

### `stores` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåº—èˆ—ãƒžã‚¹ã‚¿ï¼‰
- store_id: åº—èˆ—ID
- store_name: åº—èˆ—å
- region: åœ°åŸŸ
- prefecture: éƒ½é“åºœçœŒ
- opening_date: é–‹åº—æ—¥

## å­¦ç¿’ã§ãã‚‹SQLæ–‡æ³•

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ä»¥ä¸‹ã®åˆ†æžç³»SQLæ–‡æ³•ã‚’å®Ÿè·µã§ãã¾ã™ï¼š

### 1. åŸºæœ¬çš„ãªSELECT
- ã‚«ãƒ©ãƒ é¸æŠž
- LIMITå¥ï¼ˆå®Ÿå‹™ã§ä¸€èˆ¬çš„ã€æ¨™æº–SQLã¯FETCH FIRSTï¼‰
- ORDER BY
- ASå¥ã«ã‚ˆã‚‹åˆ—åæŒ‡å®šï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨èªžã§ã®å‘½åï¼‰

### 2. æ—¥ä»˜ãƒ»æ–‡å­—åˆ—é–¢æ•°
æ—¥ä»˜é–¢æ•°:
- `DATE_TRUNC()`: æœˆæ¬¡é›†è¨ˆ
- `DAYNAME()`: æ›œæ—¥åˆ¥åˆ†æž
- `EXTRACT()`: å¹´ãƒ»æœˆãƒ»æ—¥ã®æŠ½å‡º
- `BETWEEN`: æ—¥ä»˜ç¯„å›²æŠ½å‡º
- æ—¥ä»˜ã®å¼•ãç®—ï¼ˆæœŸé–“è¨ˆç®—ï¼‰

æ–‡å­—åˆ—é–¢æ•°:
- `CONCAT()`: æ–‡å­—åˆ—çµåˆ
- `UPPER()`, `LOWER()`: å¤§æ–‡å­—å°æ–‡å­—å¤‰æ›
- `LENGTH()`: æ–‡å­—æ•°å–å¾—
- `SUBSTRING()`, `LEFT()`: éƒ¨åˆ†æ–‡å­—åˆ—å–å¾—

### 3. WHEREæ¡ä»¶
- æ¯”è¼ƒæ¼”ç®—å­ï¼ˆ>=, <=, =ï¼‰
- è«–ç†æ¼”ç®—å­ï¼ˆAND, ORï¼‰
- æ—¥ä»˜ç¯„å›²æŒ‡å®š

### 4. JOINï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«çµåˆï¼‰
- INNER JOIN
- 2ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆ
- 3ãƒ†ãƒ¼ãƒ–ãƒ«ä»¥ä¸Šã®å¤šé‡çµåˆ

### 5. GROUP BYé›†è¨ˆ
- `COUNT()`, `SUM()`, `AVG()`
- `COUNT(DISTINCT)`
- ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥é›†è¨ˆ

### 6. CASEå¼
- æ¡ä»¶åˆ†å²
- ãƒ©ãƒ³ã‚¯åˆ†é¡ž
- ãƒ”ãƒœãƒƒãƒˆé›†è¨ˆï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥å£²ä¸Šã‚’åˆ—ã«å±•é–‹ï¼‰

### 7. ç¸¦æŒã¡â‡”æ¨ªæŒã¡å¤‰æ›
- ãƒ”ãƒœãƒƒãƒˆï¼ˆç¸¦â†’æ¨ªï¼‰: CASEå¼ + GROUP BY ã§ã‚«ãƒ†ã‚´ãƒªã‚’åˆ—ã«å±•é–‹
- ã‚¢ãƒ³ãƒ”ãƒœãƒƒãƒˆï¼ˆæ¨ªâ†’ç¸¦ï¼‰: UNION ALL ã§åˆ—ã‚’è¡Œã«å¤‰æ›
- å®Ÿå‹™ã§é »å‡ºã®ãƒ‡ãƒ¼ã‚¿æ•´å½¢ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

### 8. Windowé–¢æ•°
- `RANK()`, `ROW_NUMBER()`: ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- `SUM() OVER()`: ç´¯ç©é›†è¨ˆ
- `LAG()`, `LEAD()`: å‰å¾Œè¡Œå‚ç…§
- `PARTITION BY`: ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥Windowé–¢æ•°
- è³¼è²·é »åº¦åˆ†æžï¼ˆå‰å›žè³¼è²·æ—¥ã‹ã‚‰ã®æ—¥æ•°ï¼‰

### 9. CTEï¼ˆCommon Table Expressionï¼‰
- `WITH`å¥
- è¤‡æ•°CTEã®çµ„ã¿åˆã‚ã›
- æ®µéšŽçš„ãªãƒ‡ãƒ¼ã‚¿åŠ å·¥
- å¯èª­æ€§ã®é«˜ã„ã‚¯ã‚¨ãƒªè¨˜è¿°

## ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚º

### ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 

`data/` ãƒ•ã‚©ãƒ«ãƒ€ã«ç‹¬è‡ªã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã€`app.py` ã® `init_db()` é–¢æ•°ã‚’ç·¨é›†ï¼š

```python
# ç‹¬è‡ªã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ä¾‹
con.execute(f"""
    CREATE TABLE my_table AS 
    SELECT * FROM read_csv_auto('{data_dir}/my_data.csv')
""")
```

### ãƒ‡ãƒ¼ã‚¿ã®è¦ä»¶

DuckDBã¯ä»¥ä¸‹ã®å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼š
- CSVï¼ˆè‡ªå‹•åž‹æŽ¨è«–ï¼‰
- Parquet
- JSON

CSVã¯1è¡Œç›®ãŒãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚«ãƒ©ãƒ åï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### S3ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆEC2ã§IAM Roleä½¿ç”¨æ™‚ï¼‰

```python
# DuckDBã®httpfsæ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
con.execute("INSTALL httpfs; LOAD httpfs;")
con.execute("SET s3_region='ap-northeast-1';")

# S3ã‹ã‚‰Parquetã‚’èª­ã¿è¾¼ã‚€
con.execute("""
    CREATE TABLE my_s3_table AS 
    SELECT * FROM read_parquet('s3://my-bucket/data/*.parquet')
""")
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- Streamlit: Webã‚¢ãƒ—ãƒªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- DuckDB: é«˜é€Ÿãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªSQLåˆ†æžãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- Pandas: ãƒ‡ãƒ¼ã‚¿æ“ä½œ

---

## ðŸ“Š SQLæ¨™æº–ã¨å®Ÿç”¨æ€§ã®ãƒãƒ©ãƒ³ã‚¹

ã“ã®ã‚¢ãƒ—ãƒªã¯æ¨™æº–SQLï¼ˆISO/IEC 9075ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã¾ã™ãŒã€å®Ÿå‹™ã§ã®ä½¿ã„ã‚„ã™ã•ã‚‚è€ƒæ…®ã—ã¦ã„ã¾ã™ã€‚

### æ¨™æº–SQLæ©Ÿèƒ½ã®ã¿ã‚’ä½¿ç”¨ï¼ˆLIMITã‚’é™¤ãï¼‰

SQL:1992ï¼ˆSQL-92ï¼‰:
- SELECT, FROM, WHERE, GROUP BY, HAVING, ORDER BY
- JOINï¼ˆINNER, LEFT, RIGHT, FULL OUTERï¼‰
- CASEå¼ã€é›†è¨ˆé–¢æ•°ï¼ˆCOUNT, SUM, AVG, MIN, MAXï¼‰
- DISTINCTã€UNIONã€SUBSTRINGã€UPPERã€LOWERã€CHAR_LENGTH
- EXTRACTï¼ˆæ—¥ä»˜éƒ¨åˆ†ã®å–å¾—ï¼‰

SQL:1999ï¼ˆSQL3ï¼‰:
- CTEï¼ˆWITHå¥ï¼‰

SQL:2003:
- Windowé–¢æ•°ï¼ˆRANK, ROW_NUMBER, DENSE_RANK, LAG, LEAD, NTILE ãªã©ï¼‰

### çµæžœä»¶æ•°ã®åˆ¶é™ã«ã¤ã„ã¦

æ¨™æº–SQLï¼ˆSQL:2008ï¼‰: `FETCH FIRST n ROWS ONLY`

å®Ÿå‹™ã§ã®æ…£ä¾‹: `LIMIT n`
- PostgreSQLã€MySQLã€BigQueryã€Athenaã€Snowflakeã€DuckDBãªã©ä¸»è¦ãªåˆ†æžç³»DBã§åºƒãã‚µãƒãƒ¼ãƒˆ
- çŸ­ãæ›¸ã‘ã¦èª­ã¿ã‚„ã™ã„
- ã“ã®ã‚¢ãƒ—ãƒªã§ã¯å®Ÿç”¨æ€§ã‚’é‡è¦–ã—ã€`LIMIT` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™

å•é¡Œ1ã§ `FETCH FIRST` ã‚’ç´¹ä»‹ã—ãŸä¸Šã§ã€ä»¥é™ã®å•é¡Œã§ã¯ `LIMIT` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹äº’æ›æ€§

ã“ã®ã‚¢ãƒ—ãƒªã®ã‚¯ã‚¨ãƒªã¯æ¨™æº–SQLã«æ¦‚ã­æº–æ‹ ã—ã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§å‹•ä½œã™ã‚‹æƒ³å®šã§ã™ï¼ˆDuckDBä»¥å¤–ã®ç’°å¢ƒã§ã®å‹•ä½œæ¤œè¨¼ã¯ã—ã¦ã„ã¾ã›ã‚“ï¼‰ï¼š
- DuckDB
- Amazon Athenaï¼ˆApache Trinoï¼‰
- Snowflake
- BigQuery
